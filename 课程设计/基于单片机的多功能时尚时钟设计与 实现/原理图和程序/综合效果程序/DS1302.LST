C51 COMPILER V8.08   DS1302                                                                04/25/2013 23:45:24 PAGE 1   


C51 COMPILER V8.08, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN DS1302.OBJ
COMPILER INVOKED BY: D:\Program Files\keil-3\C51\BIN\C51.EXE DS1302.C LARGE BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include "NEW_8051.H"
   2          #include "task.h"
   3          
   4          sbit T_CLK=P3^5;                    //DS1302引脚连接
   5          sbit T_IO =P3^6;
   6          sbit T_RST=P3^7;
   7          
   8          sbit ACC0=ACC^0;           //1bit数据存储位
   9          sbit ACC7=ACC^7;
  10          
  11          uchar starts_time[7]={0x00,0x10,0x22,0x20,0x05,0x04,0x10};       //初始化后设置
  12          uchar Sec;
  13          uchar Cent;
  14          uchar Hour;
  15          uchar Year;
  16          uchar Day;
  17          uchar Week;
  18          uchar Month;
  19          
  20          /******************************************************************/
  21          
  22          //根据选择调整相应项目
  23          void Set(uchar sel,uchar sel_1) 
  24          {
  25   1        uchar address,time;
  26   1        uchar max,min;
  27   1       if(sel==1)  {address=0x84; max=23;min=0;}    //小时
  28   1       if(sel==2)  {address=0x82; max=59;min=0;}    //分钟
  29   1       if(sel==3)  {address=0x88; max=12;min=1;}    //月
  30   1       if(sel==4)  {address=0x86; max=31;min=1;}    //日
  31   1       if(sel==5)  {address=0x8a; max=7;min=1;}    //星期
  32   1       
  33   1        time=R1302(address+1)/16*10+R1302(address+1)%16;         //变成BCD码
  34   1        if (sel_1==1) time++;  else time--;
  35   1        if(time>max) time=min;   
  36   1        if(time<min) time=max;
  37   1                 
  38   1        W1302(0x8e,0x00);
  39   1        W1302(address,time/10*16+time%10);             
  40   1        W1302(0x8e,0x80);  
  41   1      }
  42          
  43          //********DS1302读写程序***************//
  44          /******************************************************************** 
  45          函 数 名：RTInputByte()
  46          功    能：实时时钟写入一字节
  47          说    明：往DS1302写入1Byte数据 (内部函数)
  48          入口参数：d 写入的数据 
  49          返 回 值：无  
  50          ***********************************************************************/
  51          void RTInputByte(uchar d) 
  52          { 
  53   1          uchar h;
  54   1          ACC = d;
  55   1          for(h=8; h>0; h--)
C51 COMPILER V8.08   DS1302                                                                04/25/2013 23:45:24 PAGE 2   

  56   1          {
  57   2              T_IO = ACC0;           /*相当于汇编中的 RRC */
  58   2              T_CLK = 1;
  59   2              T_CLK = 0;
  60   2              ACC = ACC >> 1; 
  61   2          } 
  62   1      }
  63          /******************************************************************** 
  64          函 数 名：RTOutputByte()
  65          功    能：实时时钟读取一字节
  66          说    明：从DS1302读取1Byte数据 (内部函数)
  67          入口参数：无  
  68          返 回 值：ACC
  69          设    计：zhaojunjie           日    期：2002-03-19
  70          修    改：                     日    期： 
  71          ***********************************************************************/
  72          uchar RTOutputByte(void) 
  73          { 
  74   1          uchar h;
  75   1          for(h=8; h>0; h--)
  76   1          {
  77   2              ACC = ACC >>1;         /*相当于汇编中的 RRC */
  78   2              ACC7 = T_IO;
  79   2              T_CLK = 1;
  80   2              T_CLK = 0;
  81   2          } 
  82   1          return(ACC); 
  83   1      }
  84          /******************************************************************** 
  85          函 数 名：W1302()
  86          功    能：往DS1302写入数据
  87          说    明：先写地址，后写命令/数据 (内部函数)
  88          调    用：RTInputByte() , RTOutputByte()
  89          入口参数：ucAddr: DS1302地址, ucData: 要写的数据
  90          返 回 值：无
  91          ***********************************************************************/
  92          void W1302(uchar ucAddr, uchar ucDa)
  93          {
  94   1          T_RST = 0;
  95   1          T_CLK = 0;
  96   1          T_RST = 1;
  97   1          RTInputByte(ucAddr);       /* 地址，命令 */
  98   1          RTInputByte(ucDa);       /* 写1Byte数据*/
  99   1          T_CLK = 1;
 100   1          T_RST = 0;
 101   1      }
 102          /******************************************************************** 
 103          函 数 名：R1302()
 104          功    能：读取DS1302某地址的数据
 105          说    明：先写地址，后读命令/数据 (内部函数)
 106          调    用：RTInputByte() , RTOutputByte()
 107          入口参数：ucAddr: DS1302地址
 108          返 回 值：ucData :读取的数据
 109          ***********************************************************************/
 110          uchar R1302(uchar ucAddr)
 111          {
 112   1          uchar ucData;
 113   1          T_RST = 0;
 114   1          T_CLK = 0;
 115   1          T_RST = 1;
 116   1          RTInputByte(ucAddr);             /* 地址，命令 */
 117   1          ucData = RTOutputByte();         /* 读1Byte数据 */
C51 COMPILER V8.08   DS1302                                                                04/25/2013 23:45:24 PAGE 3   

 118   1          T_CLK = 1;
 119   1          T_RST = 0;
 120   1          return(ucData);
 121   1      }
 122          /******************************************************/
 123          void Auto_Set1302(uchar *pClock) 
 124          {
 125   1          uchar h;
 126   1          uchar ucAddr = 0x80; 
 127   1              if(((R1302(0x81))&0x80)==0x80)
 128   1              {
 129   2                  W1302(0x8e,0x00);           /* 控制命令,WP=0,写操作?*/
 130   2                  for(h =7; h>0; h--)
 131   2                  { 
 132   3                      W1302(ucAddr,*pClock);  /* 秒 分 时 日 月 星期 年 */ 
 133   3                      pClock++;
 134   3                      ucAddr +=2;
 135   3                  }
 136   2      //         W1302(ucNumRows_adder,0);
 137   2      //         W1302(ucNumRows_p_adder,0);
 138   2      //         W1302(DISP_TIME_adder,170); 
 139   2                      W1302(Auto_adder,0x00);
 140   2      //              W1302(0XC2,0X03);                       //初始自动转换显示时间为3秒。
 141   2                  W1302(0x8e,0x80);           /* 控制命令,WP=1,写保护?*/
 142   2      
 143   2              }
 144   1      }
 145          /******************************************************************** 
 146          函 数 名：Set1302()
 147          功    能：设置初始时间
 148          说    明：先写地址，后读命令/数据(寄存器多字节方式)
 149          调    用：W1302()
 150          入口参数：pClock: 设置时钟数据地址 格式为: 秒 分 时 日 月 星期 年
 151                                         7Byte (BCD码)1B 1B 1B 1B 1B  1B  1B
 152          返 回 值：无
 153          ***********************************************************************/
 154          void Set1302(uchar *pClock) 
 155          {
 156   1          uchar h;
 157   1          uchar ucAddr = 0x80; 
 158   1          W1302(0x8e,0x00);           /* 控制命令,WP=0,写操作?*/
 159   1          for(h =7; h>0; h--)
 160   1          { 
 161   2              W1302(ucAddr,*pClock);  /* 秒 分 时 日 月 星期 年 */ 
 162   2              pClock++;
 163   2              ucAddr +=2;
 164   2          }
 165   1      //      W1302(0xc0,0x01);
 166   1      //      W1302(0XC2,0X03);                       //初始自动转换显示时间为3秒。
 167   1          W1302(0x8e,0x80);           /* 控制命令,WP=1,写保护?*/
 168   1      
 169   1      }
 170          /******************读取DS1302中的时间****************/
 171          void du1302()
 172          {
 173   1            Sec=R1302(0x81);   //对取 秒 分 时 日 月 星期 年
 174   1                Cent=R1302(0x83);
 175   1                Hour=R1302(0x85);
 176   1                Day=R1302(0x87);
 177   1                Month=R1302(0x89);
 178   1                //Week=R1302(0x8b);
 179   1                //Year=R1302(0x8d);                           
C51 COMPILER V8.08   DS1302                                                                04/25/2013 23:45:24 PAGE 4   

 180   1                //b=R1302(0xc1);
 181   1            //a=R1302(0xc3);
 182   1                //a=a/16*10+a%16;
 183   1               
 184   1      }
 185          /*********************************************************************************************
 186          函数名：1302直接写数据程序
 187          调  用：write_1302Data
 188          参  数：无
 189          返回值：无
 190          结  果：时钟芯片直接写数据，自动打开写保护程序
 191          备  注：适用于DS1302芯片+32.768KHz6pF晶体
 192          /**********************************************************************************************/
 193          void  write_1302Data (uchar  ucAddr,uchar  Value)
 194          {   
 195   1              W1302(0x8e,0x00);           /* 控制命令,WP=0,写操作?*/ 
 196   1          W1302(ucAddr,Value);        //地址和数据
 197   1          W1302(0x8e,0x80);           /* 控制命令,WP=1,写保护?*/ 
 198   1      }
 199          /*********************************************************************************/
 200          /*************************************************************************************
 201          ************************************************************************************
 202          ***********************                                     ***************************
 203          ***********************    http://59tiaoba.taobao.com       ***************************
 204          ***********************                                     ***************************
 205          ***************************************程序编写：Fucp***************************************
 206          **********************************************************************************/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    450    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     14       5
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
